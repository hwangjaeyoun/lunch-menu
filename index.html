<!DOCTYPE html>
<html lang="ko">
<head>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="ì´ë¯¸ì§€ì£¼ì†Œ.png"> 

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ ì ì‹¬ ë­ ë¨¹ì§€?</title>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF6B6B; --bg: #F8F9FA; --card: #FFFFFF; --text: #333; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 400px; background: var(--card); padding: 24px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { font-weight: 800; font-size: 24px; text-align: center; color: var(--primary); margin-bottom: 20px; }
        .result-box { background: #FFF0F0; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 20px; border: 2px dashed var(--primary); }
        #selected-menu { font-size: 28px; font-weight: 800; color: var(--primary); display: block; margin-top: 10px; }
        .btn-main { background: var(--primary); color: white; width: 100%; font-size: 18px; padding: 16px; border: none; border-radius: 15px; font-weight: 700; cursor: pointer; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        .input-group { display: flex; gap: 8px; margin-bottom: 20px; }
        input { flex: 1; padding: 12px; border: 1px solid #DDD; border-radius: 10px; outline: none; }
        .btn-add { background: #333; color: white; border: none; border-radius: 10px; padding: 0 15px; cursor: pointer; }
        .menu-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #F0F0F0; font-size: 15px; }
        .menu-actions button { margin-left: 5px; padding: 4px 8px; border-radius: 5px; border: 1px solid #DDD; background: white; cursor: pointer; font-size: 12px; }
        .btn-del { color: #ff4d4d; }
        .history-tag { font-size: 10px; color: white; background: #FFADAD; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ´ ì ì‹¬ ë©”ë‰´ ì¶”ì²œ</h1>
    <div class="result-box">
        <span>ì˜¤ëŠ˜ì˜ ë©”ë‰´ëŠ”?</span>
        <strong id="selected-menu">???</strong>
    </div>
    <button class="btn-main" onclick="pickLunch()">ë©”ë‰´ ëœë¤ ë½‘ê¸°!</button>

<style>
    .btn-reset {
        background: none;
        border: 1px solid #ccc;
        color: #999;
        font-size: 12px;
        padding: 5px 10px;
        border-radius: 8px;
        cursor: pointer;
        float: right; /* ìš°ì¸¡ ì •ë ¬ */
    }
    .btn-reset:hover { background: #f0f0f0; color: #666; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
</style>

<div class="list-section">
    <div class="section-header">
        <div style="font-size: 14px; font-weight: 600; color: #888;">ì „ì²´ ë©”ë‰´ ê´€ë¦¬</div>
        <button class="btn-reset" onclick="resetHistory()">íˆìŠ¤í† ë¦¬ ë¦¬ì…‹</button>
    </div>
    <div id="menu-list-ui"></div>
</div>
    <div class="input-group">
        <input type="text" id="menu-input" placeholder="ìƒˆ ë©”ë‰´ ì…ë ¥">
        <button class="btn-add" onclick="addNewMenu()">ë“±ë¡</button>
    </div>

    <div style="font-size: 14px; font-weight: 600; color: #888; margin-bottom: 10px;">ì „ì²´ ë©”ë‰´ ê´€ë¦¬</div>
    <div id="menu-list-ui"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD81V5_SpVFegaBiVAYX3cQoTfFERsU4co",
  authDomain: "lunch-17f91.firebaseapp.com",
  projectId: "lunch-17f91",
  storageBucket: "lunch-17f91.firebasestorage.app",
  messagingSenderId: "708783829174",
  appId: "1:708783829174:web:b482e32d49571406657617",
  measurementId: "G-1DGKFF4VRM"
};
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° UI ë Œë”ë§
    async function loadData() {
        const menuSnap = await getDocs(collection(db, "menus"));
        const configSnap = await getDoc(doc(db, "config", "history"));
        const history = configSnap.exists() ? configSnap.data().lastPicks : [];
        
        const listUi = document.getElementById('menu-list-ui');
        listUi.innerHTML = '';

        menuSnap.forEach((docSnap) => {
            const data = docSnap.data();
            const isHistory = history.includes(data.name);
            listUi.innerHTML += `
                <div class="menu-item">
                    <span>${data.name} ${isHistory ? '<span class="history-tag">ìµœê·¼ì„ ì •</span>' : ''}</span>
                    <div class="menu-actions">
                        <button onclick="editMenu('${docSnap.id}', '${data.name}')">ìˆ˜ì •</button>
                        <button class="btn-del" onclick="deleteMenu('${docSnap.id}')">ì‚­ì œ</button>
                    </div>
                </div>`;
        });
        return { history, menus: menuSnap.docs.map(d => d.data().name) };
    }

    // ë©”ë‰´ ë“±ë¡
    window.addNewMenu = async () => {
        const name = document.getElementById('menu-input').value;
        if(!name) return;
        await addDoc(collection(db, "menus"), { name: name });
        location.reload();
    };

    // ë©”ë‰´ ì‚­ì œ
    window.deleteMenu = async (id) => {
        if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            await deleteDoc(doc(db, "menus", id));
            location.reload();
        }
    };

    // ë©”ë‰´ ìˆ˜ì •
    window.editMenu = async (id, oldName) => {
        const newName = prompt("ë©”ë‰´ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”", oldName);
        if(newName && newName !== oldName) {
            await updateDoc(doc(db, "menus", id), { name: newName });
            location.reload();
        }
    };

// 1. íˆìŠ¤í† ë¦¬ ë¦¬ì…‹ í•¨ìˆ˜ ì¶”ê°€
window.resetHistory = async () => {
    if (confirm("ìµœê·¼ 3íšŒ ë‹¹ì²¨ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ì œ ëª¨ë“  ë©”ë‰´ê°€ ë‹¤ì‹œ ì„ íƒ í›„ë³´ì— í¬í•¨ë©ë‹ˆë‹¤.")) {
        try {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            
            // Firebaseì˜ config/history ë¬¸ì„œì˜ lastPicks ë°°ì—´ì„ ë¹ˆ ë°°ì—´ë¡œ ì—…ë°ì´íŠ¸
            await updateDoc(doc(db, "config", "history"), { 
                lastPicks: [] 
            });

            alert("íˆìŠ¤í† ë¦¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!");
            location.reload(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë°˜ì˜
        } catch (error) {
            console.error("ë¦¬ì…‹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
            alert("ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    }
};
    // ë©”ë‰´ ë½‘ê¸° (3íšŒ ì¤‘ë³µ ë°©ì§€ ë¡œì§)
    window.pickLunch = async () => {
        const { history, menus } = await loadData();
        const available = menus.filter(m => !history.includes(m));

        if(available.length === 0) return alert("ë½‘ì„ ìˆ˜ ìˆëŠ” ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤!");

        const selected = available[Math.floor(Math.random() * available.length)];
        document.getElementById('selected-menu').innerText = selected;

        const newHistory = [selected, ...history].slice(0, 3);
        await updateDoc(doc(db, "config", "history"), { lastPicks: newHistory });
    };

    loadData();
</script>
</body>
</html>

